# Batch Inferencing

Some problem statements do not warrant the deployment of an API server
but instead methods for conducting batched inferencing where a batch
of data is provided to a script and it is able to churn out a set of
predictions, perhaps exported to a file.

This template provides a Python script (`src/batch_infer.py`) for
this purpose.

Let's first download some data on our local machine for us to conduct
batch inferencing on:

=== "Linux/macOS/VSCode Server Terminal"

    ```bash
    mkdir -p data/batch-infer && cd $_
    echo -n "Output1" > in1.txt
    echo -n "Output2" > in2.txt
    echo -n "Output3" > in3.txt
    ```

=== "Windows PowerShell"

    ```powershell
    cd data
    wget https://storage.googleapis.com/aisg-mlops-pub-data/kapitan-hull/batched-mnist-input-data.zip
    Expand-Archive -Path batched-mnist-input-data.zip -DestinationPath .
    rm batched-mnist-input-data.zip
    ```

To execute the batch inferencing script locally:

=== "Linux/macOS/VSCode Server Terminal"

    ```bash
    # Navigate back to root directory
    cd "$(git rev-parse --show-toplevel)"
    conda activate {{cookiecutter.repo_name}}
    python src/batch_infer.py
    ```

=== "Windows PowerShell"

    ```powershell
    # Navigate back to root directory
    Set-Location -Path (git rev-parse --show-toplevel)
    conda activate {{cookiecutter.repo_name}}
    python src/batch_infer.py
    ```

The script will log to the terminal the location of the
`.jsonl` file (`batch-infer-res.jsonl`) containing predictions that
look like such:

```jsonl
...
{"time": "2024-02-29T10:09:00+0000", "text_filepath": "./data/batch-infer/in1.txt", "prediction": "Output1"}
{"time": "2024-02-29T10:09:00+0000", "text_filepath": "./data/batch-infer/in2.txt", "prediction": "Output2"}
{"time": "2024-02-29T10:09:00+0000", "text_filepath": "./data/batch-infer/in3.txt", "prediction": "Output3"}
...
```

The `hydra.job.chdir=True` flag writes the `.jsonl` file containing
the predictions to a subdirectory within the `outputs` folder. See 
[here] for more information on outputs generated by Hydra.

[here]: https://hydra.cc/docs/tutorials/basic/running_your_app/working_directory/